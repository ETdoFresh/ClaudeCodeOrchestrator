<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:html="clr-namespace:TheArtOfDev.HtmlRenderer.Avalonia;assembly=Avalonia.HtmlRenderer"
             xmlns:conv="using:ClaudeCodeOrchestrator.App.Converters"
             xmlns:vm="using:ClaudeCodeOrchestrator.App.ViewModels.Docking"
             xmlns:vmBase="using:ClaudeCodeOrchestrator.App.ViewModels"
             mc:Ignorable="d" d:DesignWidth="600" d:DesignHeight="400"
             x:Class="ClaudeCodeOrchestrator.App.Views.Panels.SessionView"
             x:DataType="vm:SessionDocumentViewModel"
             VerticalAlignment="Stretch"
             HorizontalAlignment="Stretch"
             Background="#1E1E1E">

    <UserControl.Resources>
        <conv:MarkdownToHtmlConverter x:Key="MarkdownToHtml" />
        <conv:DiffToHtmlConverter x:Key="DiffToHtml" />
        <conv:CodePreviewConverter x:Key="CodePreview" />
        <conv:ImageAttachmentToBitmapConverter x:Key="ImageToBitmap" />
    </UserControl.Resources>

    <Grid RowDefinitions="Auto,*,Auto">
        <!-- Header with branch info -->
        <Border Grid.Row="0" Padding="12,8" Background="#252526" BorderBrush="#3C3C3C" BorderThickness="0,0,0,1">
            <Grid ColumnDefinitions="*,Auto">
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12">
                    <TextBlock Text="&#x1F33F;" FontSize="14" />
                    <TextBlock Text="{Binding WorktreeBranch}" FontSize="13" Foreground="#569CD6" />
                    <TextBlock Text="(Preview)"
                               FontSize="12"
                               Foreground="#569CD6"
                               FontStyle="Italic"
                               IsVisible="{Binding IsPreview}" />
                    <!-- Processing spinner - uses Ellipse with StrokeDashArray for centered rotation -->
                    <Panel Classes="arc-spinner"
                           IsVisible="{Binding IsProcessing}"
                           ToolTip.Tip="Processing...">
                        <Ellipse Stroke="#007ACC"
                                 StrokeThickness="2" />
                    </Panel>
                    <TextBlock Text="â€¢" Foreground="#666666" />
                    <TextBlock FontSize="13" Foreground="#858585">
                        <Run Text="Cost: $" />
                        <Run Text="{Binding TotalCost, StringFormat=N4}" />
                    </TextBlock>
                    <!-- Iteration counter (for jobs) -->
                    <TextBlock Text="â€¢"
                               Foreground="#666666"
                               IsVisible="{Binding IterationText, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                    <TextBlock Text="{Binding IterationText}"
                               FontSize="13"
                               Foreground="#4EC9B0"
                               FontWeight="SemiBold"
                               IsVisible="{Binding IterationText, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                               ToolTip.Tip="Current job iteration" />
                </StackPanel>
                <!-- Action buttons -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4">
                    <!-- Copy Chat button -->
                    <Button Command="{Binding CopyChatCommand}"
                            Padding="8,4"
                            FontSize="12"
                            Background="Transparent"
                            Foreground="#CCCCCC"
                            BorderThickness="1"
                            BorderBrush="#3C3C3C"
                            CornerRadius="4"
                            ToolTip.Tip="Copy entire conversation to clipboard"
                            AutomationProperties.AutomationId="CopyChatButton">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <TextBlock Text="ðŸ“‹" />
                            <TextBlock Text="Copy Chat" />
                        </StackPanel>
                    </Button>
                    <!-- VS Code button - shown when VS Code is available -->
                    <Button Command="{Binding OpenInVSCodeCommand}"
                            Padding="10,4"
                            FontSize="12"
                            Background="#007ACC"
                            Foreground="White"
                            ToolTip.Tip="Open in VS Code"
                            IsVisible="{Binding CanOpenInVSCode}"
                            AutomationProperties.AutomationId="OpenInVSCodeButton">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <TextBlock Text="{}{}" FontWeight="Bold" />
                            <TextBlock Text="VS Code" />
                        </StackPanel>
                    </Button>
                    <!-- Run button - shown when executable is configured -->
                    <Button Command="{Binding RunCommand}"
                            Padding="10,4"
                            FontSize="12"
                            Background="#4EC9B0"
                            Foreground="White"
                            ToolTip.Tip="Run application"
                            IsVisible="{Binding CanRun}"
                            AutomationProperties.AutomationId="RunButton">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <TextBlock Text="â–¶" />
                            <TextBlock Text="Run" />
                        </StackPanel>
                    </Button>
                    <!-- Delete button -->
                    <Button Command="{Binding DeleteWorktreeCommand}"
                            Padding="10,4"
                            FontSize="12"
                            Background="#D32F2F"
                            Foreground="White"
                            ToolTip.Tip="Delete this worktree"
                            AutomationProperties.AutomationId="DeleteWorktreeButton">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <TextBlock Text="âœ•" />
                            <TextBlock Text="Delete" />
                        </StackPanel>
                    </Button>
                    <!-- Merge button - shown when ready to merge -->
                    <Button Command="{Binding MergeCommand}"
                            Padding="10,4"
                            FontSize="12"
                            Background="#4CAF50"
                            Foreground="White"
                            ToolTip.Tip="Merge to base branch"
                            IsVisible="{Binding IsReadyToMerge}"
                            AutomationProperties.AutomationId="MergeButton">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <TextBlock Text="â†—" />
                            <TextBlock Text="Merge" />
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Messages area -->
        <ScrollViewer x:Name="MessagesScrollViewer" Grid.Row="1" Padding="12,8,12,0" HorizontalScrollBarVisibility="Disabled">
            <StackPanel Margin="0,0,0,60">
            <!-- Load previous messages button at top -->
            <Border IsVisible="{Binding HasMoreMessages}"
                    Margin="0,0,0,8"
                    HorizontalAlignment="Center">
                <Button Command="{Binding LoadMoreMessagesActionCommand}"
                        IsEnabled="{Binding !IsLoadingMore}"
                        Classes="vscode-secondary-button"
                        Padding="12,6">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Panel Classes="arc-spinner" IsVisible="{Binding IsLoadingMore}">
                            <Ellipse Stroke="#007ACC" StrokeThickness="2" />
                        </Panel>
                        <TextBlock Text="Load Previous Messages" VerticalAlignment="Center" IsVisible="{Binding !IsLoadingMore}" />
                        <TextBlock Text="Loading..." VerticalAlignment="Center" IsVisible="{Binding IsLoadingMore}" />
                    </StackPanel>
                </Button>
            </Border>

            <!-- Loading history indicator -->
            <Border IsVisible="{Binding ShowLoadingState}"
                    Margin="0,60,0,0"
                    HorizontalAlignment="Center">
                <StackPanel HorizontalAlignment="Center" Spacing="12">
                    <Panel Classes="arc-spinner-large" ToolTip.Tip="Loading session history...">
                        <Ellipse Stroke="#007ACC" StrokeThickness="3" />
                    </Panel>
                    <TextBlock Text="Loading message history..."
                               FontSize="14"
                               Foreground="#858585"
                               HorizontalAlignment="Center" />
                </StackPanel>
            </Border>

            <!-- Empty state message -->
            <Border IsVisible="{Binding ShowEmptyState}"
                    Margin="0,40,0,0"
                    HorizontalAlignment="Center">
                <StackPanel HorizontalAlignment="Center" Spacing="8">
                    <TextBlock Text="Ready for input"
                               FontSize="16"
                               Foreground="#858585"
                               HorizontalAlignment="Center" />
                    <TextBlock Text="Type a message below to start a conversation"
                               FontSize="12"
                               Foreground="#666666"
                               HorizontalAlignment="Center" />
                    <Button Command="{Binding ResyncHistoryCommand}"
                            Content="Resync History"
                            Padding="12,6"
                            FontSize="12"
                            Background="#3C3C3C"
                            Foreground="#AAAAAA"
                            BorderThickness="1"
                            BorderBrush="#555555"
                            CornerRadius="4"
                            HorizontalAlignment="Center"
                            Margin="0,8,0,0"
                            ToolTip.Tip="Try to recover session history from disk"
                            AutomationProperties.AutomationId="ResyncHistoryButton" />
                </StackPanel>
            </Border>

            <ItemsControl ItemsSource="{Binding Messages}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="{x:Type vmBase:MessageViewModel}">
                        <ContentControl Content="{Binding}">
                            <ContentControl.DataTemplates>
                                <!-- System message - centered indicator -->
                                <DataTemplate DataType="{x:Type vmBase:SystemMessageViewModel}">
                                    <Border Margin="0,12,0,8" HorizontalAlignment="Center">
                                        <Border Background="#2D4A2D"
                                                CornerRadius="12"
                                                Padding="16,8"
                                                BorderBrush="#4CAF50"
                                                BorderThickness="1">
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <TextBlock Text="{Binding Icon}"
                                                           FontSize="14"
                                                           VerticalAlignment="Center" />
                                                <TextBlock Text="{Binding Content}"
                                                           FontSize="12"
                                                           Foreground="#A5D6A7"
                                                           FontWeight="SemiBold"
                                                           VerticalAlignment="Center" />
                                            </StackPanel>
                                        </Border>
                                    </Border>
                                </DataTemplate>

                                <!-- User message - light grey box style -->
                                <DataTemplate DataType="{x:Type vmBase:UserMessageViewModel}">
                                    <Border x:Name="UserMessageBorder" Margin="0,4,0,2" Padding="12,8" Background="#2D2D30" CornerRadius="6"
                                            PointerEntered="MessageBorder_PointerEntered"
                                            PointerExited="MessageBorder_PointerExited">
                                        <Grid ColumnDefinitions="*,Auto">
                                            <StackPanel Grid.Column="0" HorizontalAlignment="Stretch">
                                                <!-- Image attachments -->
                                                <ItemsControl ItemsSource="{Binding Images}"
                                                              IsVisible="{Binding HasImages}"
                                                              Margin="0,0,0,8">
                                                    <ItemsControl.ItemsPanel>
                                                        <ItemsPanelTemplate>
                                                            <WrapPanel Orientation="Horizontal" />
                                                        </ItemsPanelTemplate>
                                                    </ItemsControl.ItemsPanel>
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate>
                                                            <Border Background="#1E1E1E"
                                                                    CornerRadius="4"
                                                                    Padding="2"
                                                                    Margin="0,0,8,8">
                                                                <Image MaxWidth="200"
                                                                       MaxHeight="200"
                                                                       Stretch="Uniform"
                                                                       Source="{Binding Converter={StaticResource ImageToBitmap}}"
                                                                       ToolTip.Tip="{Binding FileName}" />
                                                            </Border>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                                <!-- Text content - SelectableTextBlock for text selection and Ctrl/Cmd+C support -->
                                                <SelectableTextBlock Text="{Binding Content}"
                                                                     TextWrapping="Wrap"
                                                                     Foreground="#CCCCCC"
                                                                     FontSize="13"
                                                                     FontFamily="-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif"
                                                                     LineHeight="19.5" />
                                            </StackPanel>
                                            <Button Grid.Column="1" x:Name="CopyButton"
                                                    Command="{Binding CopyCommand}"
                                                    Content="ðŸ“‹"
                                                    ToolTip.Tip="Copy message"
                                                    HorizontalAlignment="Right"
                                                    VerticalAlignment="Top"
                                                    Margin="8,0,20,0"
                                                    Padding="6,4"
                                                    FontSize="12"
                                                    Background="#3D3D40"
                                                    BorderThickness="0"
                                                    CornerRadius="4"
                                                    Opacity="0"
                                                    Cursor="Hand">
                                                <Button.Styles>
                                                    <Style Selector="Button:pointerover">
                                                        <Setter Property="Background" Value="#4D4D50" />
                                                    </Style>
                                                </Button.Styles>
                                            </Button>
                                        </Grid>
                                    </Border>
                                </DataTemplate>

                                <!-- Assistant message -->
                                <DataTemplate DataType="{x:Type vmBase:AssistantMessageViewModel}">
                                    <Border x:Name="AssistantMessageBorder" Margin="0,0" Padding="12,0" Background="Transparent" CornerRadius="6"
                                            PointerEntered="MessageBorder_PointerEntered"
                                            PointerExited="MessageBorder_PointerExited">
                                        <StackPanel HorizontalAlignment="Stretch">
                                            <Grid ColumnDefinitions="*,Auto">
                                                <html:HtmlLabel Grid.Column="0"
                                                                Text="{Binding TextContent, Converter={StaticResource MarkdownToHtml}}"
                                                                MaxWidth="{Binding $parent[ScrollViewer].Bounds.Width}" />
                                                <Button Grid.Column="1" x:Name="CopyButton"
                                                        Command="{Binding CopyCommand}"
                                                        Content="ðŸ“‹"
                                                        ToolTip.Tip="Copy message"
                                                        HorizontalAlignment="Right"
                                                        VerticalAlignment="Top"
                                                        Margin="8,0,20,0"
                                                        Padding="6,4"
                                                        FontSize="12"
                                                        Background="#3D3D40"
                                                        BorderThickness="0"
                                                        CornerRadius="4"
                                                        Opacity="0"
                                                        Cursor="Hand">
                                                    <Button.Styles>
                                                        <Style Selector="Button:pointerover">
                                                            <Setter Property="Background" Value="#4D4D50" />
                                                        </Style>
                                                    </Button.Styles>
                                                </Button>
                                            </Grid>

                                            <!-- Tool uses - faded/transparent style, compact -->
                                            <ItemsControl ItemsSource="{Binding ToolUses}" Margin="0,0,0,0">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate DataType="{x:Type vmBase:ToolUseViewModel}">
                                                        <Border Margin="0,0" Padding="0,0" Background="Transparent" Opacity="0.7">
                                                            <StackPanel>
                                                                <!-- Tool action header - faded text -->
                                                                <Grid ColumnDefinitions="Auto,*">
                                                                    <TextBlock Grid.Column="0" Text="{Binding ToolIcon}" FontSize="11" Margin="0,0,6,0" />
                                                                    <TextBlock Grid.Column="1" Text="{Binding ActionDescription}"
                                                                               FontSize="11"
                                                                               Foreground="#808080"
                                                                               FontStyle="Italic"
                                                                               TextWrapping="Wrap" />
                                                                </Grid>

                                                                <!-- Diff preview for Edit operations -->
                                                                <Border IsVisible="{Binding HasDiff}"
                                                                        Margin="16,2,0,0"
                                                                        Background="#1A1A1A"
                                                                        CornerRadius="4"
                                                                        Padding="0"
                                                                        MaxHeight="150"
                                                                        ClipToBounds="True">
                                                                    <ScrollViewer HorizontalScrollBarVisibility="Auto"
                                                                                  VerticalScrollBarVisibility="Auto">
                                                                        <html:HtmlLabel MaxWidth="{Binding $parent[ScrollViewer].Bounds.Width}">
                                                                            <html:HtmlLabel.Text>
                                                                                <MultiBinding Converter="{StaticResource DiffToHtml}">
                                                                                    <Binding Path="OldString" />
                                                                                    <Binding Path="NewString" />
                                                                                </MultiBinding>
                                                                            </html:HtmlLabel.Text>
                                                                        </html:HtmlLabel>
                                                                    </ScrollViewer>
                                                                </Border>

                                                                <!-- Content preview for Write operations -->
                                                                <Border IsVisible="{Binding HasWriteContent}"
                                                                        Margin="16,2,0,0"
                                                                        Background="#1A1A1A"
                                                                        CornerRadius="4"
                                                                        Padding="0"
                                                                        MaxHeight="150"
                                                                        ClipToBounds="True">
                                                                    <ScrollViewer HorizontalScrollBarVisibility="Auto"
                                                                                  VerticalScrollBarVisibility="Auto">
                                                                        <html:HtmlLabel Text="{Binding WriteContent, Converter={StaticResource CodePreview}}"
                                                                                        MaxWidth="{Binding $parent[ScrollViewer].Bounds.Width}" />
                                                                    </ScrollViewer>
                                                                </Border>

                                                                <!-- Todo list display for TodoWrite operations -->
                                                                <Border IsVisible="{Binding HasTodos}"
                                                                        Margin="16,4,0,4"
                                                                        Background="#1E1E2E"
                                                                        CornerRadius="6"
                                                                        Padding="10,8"
                                                                        BorderBrush="#3C3C4C"
                                                                        BorderThickness="1">
                                                                    <ItemsControl ItemsSource="{Binding Todos}">
                                                                        <ItemsControl.ItemTemplate>
                                                                            <DataTemplate DataType="{x:Type vmBase:TodoItemViewModel}">
                                                                                <Grid ColumnDefinitions="Auto,*" Margin="0,2">
                                                                                    <TextBlock Grid.Column="0" Text="{Binding StatusIcon}" FontSize="12" VerticalAlignment="Top" Margin="0,0,8,0" />
                                                                                    <TextBlock Grid.Column="1" Text="{Binding DisplayText}"
                                                                                               FontSize="12"
                                                                                               Foreground="#D4D4D4"
                                                                                               TextWrapping="Wrap" />
                                                                                </Grid>
                                                                            </DataTemplate>
                                                                        </ItemsControl.ItemTemplate>
                                                                    </ItemsControl>
                                                                </Border>
                                                            </StackPanel>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ContentControl.DataTemplates>
                        </ContentControl>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

            <!-- Processing indicator at bottom of chat -->
            <Border IsVisible="{Binding IsProcessing}"
                    Margin="0,4,0,2"
                    Padding="12,4"
                    Background="Transparent">
                <StackPanel Orientation="Horizontal" Spacing="10">
                    <Panel Classes="arc-spinner">
                        <Ellipse Stroke="#007ACC"
                                 StrokeThickness="2" />
                    </Panel>
                    <TextBlock Text="Processing..."
                               FontSize="13"
                               Foreground="#858585"
                               VerticalAlignment="Center" />
                </StackPanel>
            </Border>
            </StackPanel>
        </ScrollViewer>

        <!-- Input area -->
        <Border Grid.Row="2" Padding="12" Background="#252526" BorderBrush="#3C3C3C" BorderThickness="0,1,0,0">
            <Grid RowDefinitions="Auto,Auto,Auto">
                <!-- Paste status indicator -->
                <Border Grid.Row="0"
                        x:Name="PasteStatusBorder"
                        IsVisible="False"
                        Background="#2D2D30"
                        CornerRadius="4"
                        Padding="8,4"
                        Margin="0,0,0,8">
                    <TextBlock x:Name="PasteStatusText"
                               FontSize="12"
                               Foreground="#4EC9B0" />
                </Border>

                <!-- Image attachments display -->
                <Border Grid.Row="1"
                        x:Name="AttachmentsArea"
                        IsVisible="False"
                        Background="#1E1E1E"
                        CornerRadius="4"
                        Padding="8"
                        Margin="0,0,0,8">
                    <StackPanel>
                        <TextBlock Text="Attached Images:"
                                   FontSize="11"
                                   Foreground="#858585"
                                   Margin="0,0,0,4" />
                        <ItemsControl x:Name="AttachmentsPanel">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel Orientation="Horizontal" />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                        </ItemsControl>
                    </StackPanel>
                </Border>

                <!-- Input row -->
                <Grid Grid.Row="2" ColumnDefinitions="*,Auto">
                    <TextBox Grid.Column="0"
                             x:Name="MessageInput"
                             Text="{Binding InputText}"
                             Watermark="Type a message... (âŒ˜V / Ctrl+V to paste image)"
                             AcceptsReturn="True"
                             TextWrapping="Wrap"
                             MaxHeight="150"
                             Background="#3C3C3C"
                             BorderBrush="#474747"
                             Foreground="#CCCCCC"
                             AutomationProperties.AutomationId="MessageInput" />

                    <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="8,0,0,0" Spacing="4">
                        <!-- Attach button -->
                        <Button x:Name="AttachButton"
                                Content="&#x1F4CE;"
                                FontSize="14"
                                Padding="8,6"
                                Background="#3C3C3C"
                                Foreground="#CCCCCC"
                                ToolTip.Tip="Attach image (or paste with âŒ˜V / Ctrl+V)" />
                        <!-- Send button - shown when not processing -->
                        <Button Command="{Binding SendMessageCommand}"
                                Content="Send"
                                IsVisible="{Binding ShowSendButton}"
                                AutomationProperties.AutomationId="SendMessageButton" />
                        <!-- Stop button - shown when processing and input is empty -->
                        <Button Command="{Binding InterruptCommand}"
                                Content="Stop"
                                Background="#6C2022"
                                IsVisible="{Binding ShowStopButton}"
                                AutomationProperties.AutomationId="StopButton" />
                        <!-- Queue button - shown when processing and has input text -->
                        <Button Command="{Binding QueueMessageCommand}"
                                Content="Queue"
                                Background="#4A6C20"
                                IsVisible="{Binding ShowQueueButton}"
                                AutomationProperties.AutomationId="QueueButton" />
                    </StackPanel>
                </Grid>
            </Grid>
        </Border>
    </Grid>
</UserControl>
