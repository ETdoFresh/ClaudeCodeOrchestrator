<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:html="clr-namespace:TheArtOfDev.HtmlRenderer.Avalonia;assembly=Avalonia.HtmlRenderer"
             xmlns:conv="using:ClaudeCodeOrchestrator.App.Converters"
             xmlns:vm="using:ClaudeCodeOrchestrator.App.ViewModels.Docking"
             xmlns:vmBase="using:ClaudeCodeOrchestrator.App.ViewModels"
             mc:Ignorable="d" d:DesignWidth="600" d:DesignHeight="400"
             x:Class="ClaudeCodeOrchestrator.App.Views.Panels.SessionView"
             x:DataType="vm:SessionDocumentViewModel"
             VerticalAlignment="Stretch"
             HorizontalAlignment="Stretch"
             Background="#1E1E1E">

    <UserControl.Resources>
        <conv:MarkdownToHtmlConverter x:Key="MarkdownToHtml" />
        <conv:DiffToHtmlConverter x:Key="DiffToHtml" />
        <conv:CodePreviewConverter x:Key="CodePreview" />
        <conv:ImageAttachmentToBitmapConverter x:Key="ImageToBitmap" />
    </UserControl.Resources>

    <Grid RowDefinitions="Auto,*,Auto">
        <!-- Header with branch info -->
        <Border Grid.Row="0" Padding="12,8" Background="#252526" BorderBrush="#3C3C3C" BorderThickness="0,0,0,1">
            <StackPanel Orientation="Horizontal" Spacing="12">
                <TextBlock Text="&#x1F33F;" FontSize="14" />
                <TextBlock Text="{Binding WorktreeBranch}" FontSize="13" Foreground="#569CD6" />
                <TextBlock Text="(Preview)"
                           FontSize="12"
                           Foreground="#569CD6"
                           FontStyle="Italic"
                           IsVisible="{Binding IsPreview}" />
                <!-- Processing spinner -->
                <Panel Classes="arc-spinner"
                       IsVisible="{Binding IsProcessing}"
                       ToolTip.Tip="Processing...">
                    <Arc Stroke="#007ACC"
                         StrokeThickness="2"
                         StartAngle="0"
                         SweepAngle="270" />
                </Panel>
                <TextBlock Text="â€¢" Foreground="#666666" />
                <TextBlock FontSize="13" Foreground="#858585">
                    <Run Text="Cost: $" />
                    <Run Text="{Binding TotalCost, StringFormat=N4}" />
                </TextBlock>
            </StackPanel>
        </Border>

        <!-- Messages area -->
        <ScrollViewer x:Name="MessagesScrollViewer" Grid.Row="1" Padding="12,8,12,24">
            <StackPanel>
            <ItemsControl ItemsSource="{Binding Messages}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="{x:Type vmBase:MessageViewModel}">
                        <ContentControl Content="{Binding}">
                            <ContentControl.DataTemplates>
                                <!-- User message - light grey box style -->
                                <DataTemplate DataType="{x:Type vmBase:UserMessageViewModel}">
                                    <Border x:Name="UserMessageBorder" Margin="0,4,0,2" Padding="12,8" Background="#2D2D30" CornerRadius="6">
                                        <Grid ColumnDefinitions="*,Auto">
                                            <StackPanel Grid.Column="0">
                                                <!-- Image attachments -->
                                                <ItemsControl ItemsSource="{Binding Images}"
                                                              IsVisible="{Binding HasImages}"
                                                              Margin="0,0,0,8">
                                                    <ItemsControl.ItemsPanel>
                                                        <ItemsPanelTemplate>
                                                            <WrapPanel Orientation="Horizontal" />
                                                        </ItemsPanelTemplate>
                                                    </ItemsControl.ItemsPanel>
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate>
                                                            <Border Background="#1E1E1E"
                                                                    CornerRadius="4"
                                                                    Padding="2"
                                                                    Margin="0,0,8,8">
                                                                <Image MaxWidth="200"
                                                                       MaxHeight="200"
                                                                       Stretch="Uniform"
                                                                       Source="{Binding Converter={StaticResource ImageToBitmap}}"
                                                                       ToolTip.Tip="{Binding FileName}" />
                                                            </Border>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                                <!-- Text content -->
                                                <html:HtmlLabel Text="{Binding Content, Converter={StaticResource MarkdownToHtml}}" />
                                            </StackPanel>
                                            <Button Grid.Column="1" x:Name="CopyButton"
                                                    Command="{Binding CopyCommand}"
                                                    Content="ðŸ“‹"
                                                    ToolTip.Tip="Copy message"
                                                    HorizontalAlignment="Right"
                                                    VerticalAlignment="Top"
                                                    Margin="0,-4,-4,0"
                                                    Padding="4,2"
                                                    FontSize="12"
                                                    Background="Transparent"
                                                    BorderThickness="0"
                                                    Opacity="0"
                                                    Cursor="Hand">
                                                <Button.Styles>
                                                    <Style Selector="Button:pointerover">
                                                        <Setter Property="Background" Value="#3D3D40" />
                                                    </Style>
                                                </Button.Styles>
                                            </Button>
                                        </Grid>
                                        <Border.Styles>
                                            <Style Selector="Border:pointerover > Grid > Button#CopyButton">
                                                <Setter Property="Opacity" Value="1" />
                                            </Style>
                                        </Border.Styles>
                                    </Border>
                                </DataTemplate>

                                <!-- Assistant message -->
                                <DataTemplate DataType="{x:Type vmBase:AssistantMessageViewModel}">
                                    <Border x:Name="AssistantMessageBorder" Margin="0,0" Padding="12,0" Background="Transparent" CornerRadius="6">
                                        <Border.Styles>
                                            <Style Selector="Border:pointerover > StackPanel > Grid > Button#CopyButton">
                                                <Setter Property="Opacity" Value="1" />
                                            </Style>
                                        </Border.Styles>
                                        <StackPanel>
                                            <Grid ColumnDefinitions="*,Auto">
                                                <html:HtmlLabel Grid.Column="0" Text="{Binding TextContent, Converter={StaticResource MarkdownToHtml}}" />
                                                <Button Grid.Column="1" x:Name="CopyButton"
                                                        Command="{Binding CopyCommand}"
                                                        Content="ðŸ“‹"
                                                        ToolTip.Tip="Copy message"
                                                        HorizontalAlignment="Right"
                                                        VerticalAlignment="Top"
                                                        Margin="0,-4,-4,0"
                                                        Padding="4,2"
                                                        FontSize="12"
                                                        Background="Transparent"
                                                        BorderThickness="0"
                                                        Opacity="0"
                                                        Cursor="Hand">
                                                    <Button.Styles>
                                                        <Style Selector="Button:pointerover">
                                                            <Setter Property="Background" Value="#3D3D40" />
                                                        </Style>
                                                    </Button.Styles>
                                                </Button>
                                            </Grid>

                                            <!-- Tool uses - faded/transparent style, compact -->
                                            <ItemsControl ItemsSource="{Binding ToolUses}" Margin="0,0,0,0">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate DataType="{x:Type vmBase:ToolUseViewModel}">
                                                        <Border Margin="0,0" Padding="0,0" Background="Transparent" Opacity="0.7">
                                                            <StackPanel>
                                                                <!-- Tool action header - faded text -->
                                                                <StackPanel Orientation="Horizontal" Spacing="6">
                                                                    <TextBlock Text="{Binding ToolIcon}" FontSize="11" />
                                                                    <TextBlock Text="{Binding ActionDescription}"
                                                                               FontSize="11"
                                                                               Foreground="#808080"
                                                                               FontStyle="Italic" />
                                                                </StackPanel>

                                                                <!-- Diff preview for Edit operations -->
                                                                <Border IsVisible="{Binding HasDiff}"
                                                                        Margin="16,2,0,0"
                                                                        Background="#1A1A1A"
                                                                        CornerRadius="4"
                                                                        Padding="0"
                                                                        MaxHeight="150">
                                                                    <html:HtmlLabel>
                                                                        <html:HtmlLabel.Text>
                                                                            <MultiBinding Converter="{StaticResource DiffToHtml}">
                                                                                <Binding Path="OldString" />
                                                                                <Binding Path="NewString" />
                                                                            </MultiBinding>
                                                                        </html:HtmlLabel.Text>
                                                                    </html:HtmlLabel>
                                                                </Border>

                                                                <!-- Content preview for Write operations -->
                                                                <Border IsVisible="{Binding HasWriteContent}"
                                                                        Margin="16,2,0,0"
                                                                        Background="#1A1A1A"
                                                                        CornerRadius="4"
                                                                        Padding="0"
                                                                        MaxHeight="150">
                                                                    <html:HtmlLabel Text="{Binding WriteContent, Converter={StaticResource CodePreview}}" />
                                                                </Border>

                                                                <!-- Todo list display for TodoWrite operations -->
                                                                <Border IsVisible="{Binding HasTodos}"
                                                                        Margin="16,4,0,4"
                                                                        Background="#1E1E2E"
                                                                        CornerRadius="6"
                                                                        Padding="10,8"
                                                                        BorderBrush="#3C3C4C"
                                                                        BorderThickness="1">
                                                                    <ItemsControl ItemsSource="{Binding Todos}">
                                                                        <ItemsControl.ItemTemplate>
                                                                            <DataTemplate DataType="{x:Type vmBase:TodoItemViewModel}">
                                                                                <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,2">
                                                                                    <TextBlock Text="{Binding StatusIcon}" FontSize="12" VerticalAlignment="Center" />
                                                                                    <TextBlock Text="{Binding DisplayText}"
                                                                                               FontSize="12"
                                                                                               Foreground="#D4D4D4"
                                                                                               VerticalAlignment="Center" />
                                                                                </StackPanel>
                                                                            </DataTemplate>
                                                                        </ItemsControl.ItemTemplate>
                                                                    </ItemsControl>
                                                                </Border>
                                                            </StackPanel>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ContentControl.DataTemplates>
                        </ContentControl>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

            <!-- Processing indicator at bottom of chat -->
            <Border IsVisible="{Binding IsProcessing}"
                    Margin="0,4,0,2"
                    Padding="12,4"
                    Background="Transparent">
                <StackPanel Orientation="Horizontal" Spacing="10">
                    <Panel Classes="arc-spinner">
                        <Arc Stroke="#007ACC"
                             StrokeThickness="2"
                             StartAngle="0"
                             SweepAngle="270" />
                    </Panel>
                    <TextBlock Text="Processing..."
                               FontSize="13"
                               Foreground="#858585"
                               VerticalAlignment="Center" />
                </StackPanel>
            </Border>
            </StackPanel>
        </ScrollViewer>

        <!-- Input area -->
        <Border Grid.Row="2" Padding="12" Background="#252526" BorderBrush="#3C3C3C" BorderThickness="0,1,0,0">
            <Grid RowDefinitions="Auto,Auto,Auto">
                <!-- Paste status indicator -->
                <Border Grid.Row="0"
                        x:Name="PasteStatusBorder"
                        IsVisible="False"
                        Background="#2D2D30"
                        CornerRadius="4"
                        Padding="8,4"
                        Margin="0,0,0,8">
                    <TextBlock x:Name="PasteStatusText"
                               FontSize="12"
                               Foreground="#4EC9B0" />
                </Border>

                <!-- Image attachments display -->
                <Border Grid.Row="1"
                        x:Name="AttachmentsArea"
                        IsVisible="False"
                        Background="#1E1E1E"
                        CornerRadius="4"
                        Padding="8"
                        Margin="0,0,0,8">
                    <StackPanel>
                        <TextBlock Text="Attached Images:"
                                   FontSize="11"
                                   Foreground="#858585"
                                   Margin="0,0,0,4" />
                        <ItemsControl x:Name="AttachmentsPanel">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel Orientation="Horizontal" />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                        </ItemsControl>
                    </StackPanel>
                </Border>

                <!-- Input row -->
                <Grid Grid.Row="2" ColumnDefinitions="*,Auto">
                    <TextBox Grid.Column="0"
                             x:Name="MessageInput"
                             Text="{Binding InputText}"
                             Watermark="Type a message... (âŒ˜V / Ctrl+V to paste image)"
                             AcceptsReturn="True"
                             TextWrapping="Wrap"
                             MaxHeight="150"
                             Background="#3C3C3C"
                             BorderBrush="#474747"
                             Foreground="#CCCCCC"
                             KeyDown="MessageInput_KeyDown"
                             AutomationProperties.AutomationId="MessageInput" />

                    <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="8,0,0,0" Spacing="4">
                        <!-- Attach button -->
                        <Button x:Name="AttachButton"
                                Content="&#x1F4CE;"
                                FontSize="14"
                                Padding="8,6"
                                Background="#3C3C3C"
                                Foreground="#CCCCCC"
                                ToolTip.Tip="Attach image (or paste with âŒ˜V / Ctrl+V)" />
                        <!-- Send button - shown when not processing -->
                        <Button Command="{Binding SendMessageCommand}"
                                Content="Send"
                                IsVisible="{Binding ShowSendButton}"
                                AutomationProperties.AutomationId="SendMessageButton" />
                        <!-- Stop button - shown when processing and input is empty -->
                        <Button Command="{Binding InterruptCommand}"
                                Content="Stop"
                                Background="#6C2022"
                                IsVisible="{Binding ShowStopButton}"
                                AutomationProperties.AutomationId="StopButton" />
                        <!-- Queue button - shown when processing and has input text -->
                        <Button Command="{Binding QueueMessageCommand}"
                                Content="Queue"
                                Background="#4A6C20"
                                IsVisible="{Binding ShowQueueButton}"
                                AutomationProperties.AutomationId="QueueButton" />
                    </StackPanel>
                </Grid>
            </Grid>
        </Border>
    </Grid>
</UserControl>
